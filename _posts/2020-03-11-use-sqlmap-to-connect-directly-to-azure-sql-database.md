---
layout: post
title: Use SQLMap to Connect Directly to Azure SQL Database
date: '2020-03-11 19:58:44 +0000'
categories:
- Azure
- Data Security and Privacy
- MSSQL
- SQL Azure
- SQL MVP
tags:
- data security
- sql injection
---

<p>I've written before about <a aria-label="using sqlmap to perform sql injection (opens in a new tab)" href="https://thomaslarock.com/2017/10/using-sqlmap-to-test-for-sql-injection-vulnerabilities/" target="_blank" rel="noreferrer noopener">using sqlmap to perform sql injection</a> testing against a website. It is also possible to use sqlmap to connect directly against a database. In this post I will show you how to use sqlmap to connect directly to Azure SQL Database. Once connected you can enumerate objects, open a shell, or run custom SQL injection scripts.</p>   <p>The sqlmap documentation is good, but not perfect. For example, if you go looking for <a aria-label="details and examples (opens in a new tab)" href="https://github.com/sqlmapproject/sqlmap/wiki/Usage" target="_blank" rel="noreferrer noopener">details and examples</a> on how to direct connect to a database you will find the following:</p>   <figure class="wp-block-image size-large"><img src="https://i2.wp.com/thomaslarock.com/wp-content/uploads/2020/02/image-2.png?fit=600%2C302&amp;ssl=1" alt="Use SQLMap to Connect Directly to Azure SQL Database" class="wp-image-19762"/></figure>   <p>There is no example given for SQL Server, so I assume 'mssql' is the correct choice for DBMS. A quick test against my Contoso Clinic website database had me trying the following code (you will need to put it correct login, password, and server host names should you try to replicate my scenraios):</p>   <pre class="wp-block-code"><code lang="python" class="language-python">c:\python38\python.exe .\sqlmap.py --batch --flush-session -d "mssql://login:password@dbserver.database.windows.net:1433/Clinic"</code></pre>   <p>This resulted in an error:</p>   <pre class="wp-block-code"><code lang="powershell" class="language-powershell">[CRITICAL] SQLAlchemy connection issue ('InterfaceError: (pyodbc.InterfaceError) ('IM002', '[IM002] [Microsoft][ODBC Driver Manager] Data source name not found and no default driver specified (0) (SQLDriverConnect)')')</code></pre>   <p>At first I focused my attention on the driver, thinking that my Surface laptop was not configured properly. I had just rebuilt the machine a few weeks ago, so it was reasonable to think something was amiss. However, it soon dawned on me that my attention should focus on SQLAlchemy, as that was being used by sqlmap to create the connection. So I decided that I would start running some tests using SQLAlchemy.</p>   <h2>Use SQLAlchemy to Connect Directly to Azure SQL Database</h2>   <p>Here's the Python script I used as a first test:</p>   <pre class="wp-block-code"><code lang="python" class="language-python">import sqlalchemy as sa engine = sa.create_engine('mssql+pymssql://login:password@dbserver.database.windows.net:1433/Clinic') connection = engine.connect() result = connection.execute("select username from users") for row in result: print("username:", row['username']) connection.close()</code></pre>   <p>This script threw the same error message, so I considered that to be a sign of progress. Now I set about researching how to connect to Azure SQL Database using SQLAlchemy. A few Google results later and I arrived at the following syntax as allowing for a successful connection:</p>   <pre class="wp-block-code"><code lang="python" class="language-python">"mssql+pymssql://login@dbserver:password@dbserver.database.windows.net:1433/Clinic"</code></pre>   <p>I needed to add the @dbserver to the end of the login, and I needed to assign a default driver. Here I chose to use pymssql. This syntax allows me to connect SQLAlchemy to an Azure SQL Database. Now that I was able to make a connection from my laptop, I went back to sqlmap. </p>   <h2>Use SQLMap to Connect Directly to Azure SQL Database</h2>   <p>The first thing I tried was the following:</p>   <pre class="wp-block-code"><code lang="python" class="language-python">c:\python38\python.exe .\sqlmap.py --batch --flush-session -d "mssql+pymssql://login@dbserver:password@dbserver.database.windows.net:1433/Clinic"</code></pre>   <p>This resulted in the following error:</p>   <pre class="wp-block-code"><code lang="powershell" class="language-powershell">[CRITICAL] invalid target details, valid syntax is for instance 'mysql://USER:PASSWORD@DBMS_IP:DBMS_PORT/DATABASE_NAME' or 'access://DATABASE_FILEPATH'</code></pre>   <p>Again, I consider this to be a sign of progress. It is a different error message, here sqlmap is clearly telling me there is a syntax error. Since I made two changes to the string, I decided to remove one and see if that works. My next test was the following:</p>   <pre class="wp-block-code"><code lang="python" class="language-python">c:\python38\python.exe .\sqlmap.py --batch --flush-session -d "mssql://login@dbserver:password@dbserver.database.windows.net:1433/Clinic"</code></pre>   <p>Success! We are able to create a connection:</p>   <pre class="wp-block-code"><code lang="powershell" class="language-powershell">[INFO] connection to Microsoft SQL Server server 'dbserver.database.windows.net:1433' established</code></pre>   <h2>Summary</h2>   <p>Connecting to Azure SQL Database with sqlmap is easy, just remember the login@dbserver format. From there you can enumerate objects, open a shell, or run custom SQL injection scripts. This flexibility makes sqlmap a great tool to use for penetration testing. I also use sqlmap to test alerts configured with <a aria-label="Advanced Threat Protection (opens in a new tab)" href="https://docs.microsoft.com/en-us/azure/sql-database/sql-database-threat-detection-overview" target="_blank" rel="noreferrer noopener">Advanced Threat Protection</a>. </p>