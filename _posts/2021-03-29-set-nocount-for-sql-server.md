---
layout: post
title: SET NOCOUNT For SQL Server
date: '2021-03-29 20:05:55 +0000'
categories:
- MSSQL
- SQL MVP
tags:
- Azure Data Studio
- SQL Server Management Studio
---

<p>Last week I was reviewing an article and found myself needing information on the use of NOCOUNT as a standard for writing stored procedures. A quick internet search found this <a href="https://thomaslarock.com/2009/03/turn-off-nocount/" target="_blank" rel="noreferrer noopener">old post of mine</a>, written back when I used to work for a living. Apparently, I was once asked to enable NOCOUNT for a specific SQL Server database. As the post suggests, this is not possible. The options for NOCOUNT are to set for the entire instance, for your specific connection, or within your T-SQL code. </p>   <p>Since the post was written well before the new-ish ALTER DATABASE SCOPED CONFIGURATION statement, I was hopeful enabling NOCOUNT for a database was now possible. Turns out you cannot, as <a href="https://docs.microsoft.com/en-us/sql/t-sql/statements/alter-database-scoped-configuration-transact-sql?view=sql-server-ver15" target="_blank" rel="noreferrer noopener">the set options listed here do not include NOCOUNT</a>. Sad trombone music. </p>   <p>But of course I tried anyway. </p>   <p>And I failed. </p>   <p>Really failed. </p>   <p>I tried to enable NOCOUNT for my instance of SQL 2019 and it wouldn't take. At all. </p>   <p>Let me explain.</p>   <h2 id="h-the-flop">The Flop</h2>   <p>Using the code from my previous post, you <a href="https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/configure-the-user-options-server-configuration-option?view=sql-server-ver15" target="_blank" rel="noreferrer noopener">enable NOCOUNT for the instance by configuring the user option to 512</a>, like this:</p>   <pre class="wp-block-preformatted">EXEC&nbsp;sys.sp_configure 'user options','512' GO RECONFIGURE GO</pre>   <p>Now, open a new query window in SQL Server Management Studio (SSMS), set the results to text to make the output easier to see, and run a query. If you are like me, you will see this:</p>   <div class="wp-block-image"><figure class="aligncenter size-large"><img src="https://thomaslarock.com/wp-content/uploads/2021/03/image-478x600.png" alt="" class="wp-image-20847"/></figure></div>   <p>Not exactly the expected behavior! My initial reaction is to assume I have screwed this up somehow. I decide to try Azure Data Studio (ADS) to connect and run the query:</p>   <div class="wp-block-image"><figure class="aligncenter size-large"><img src="https://thomaslarock.com/wp-content/uploads/2021/03/image-1-600x275.png" alt="" class="wp-image-20848"/></figure></div>   <p>Same result. Two tools, and the result set is showing a count of rows affected, despite the user option clearly having been set.</p>   <div class="wp-block-image"><figure class="aligncenter size-large"><img src="https://thomaslarock.com/wp-content/uploads/2021/03/image-2-600x445.png" alt="" class="wp-image-20849"/></figure></div>   <p>And the SSMS GUI verifies this as well:</p>   <div class="wp-block-image"><figure class="aligncenter size-large is-resized"><img src="https://thomaslarock.com/wp-content/uploads/2021/03/image-3-596x600.png" alt="" class="wp-image-20850" width="596" height="600"/></figure></div>   <h2 id="h-the-turn">The Turn</h2>   <p>Before I go any further, I want to take note that SET NOCOUNT OFF is one of those horrible phrases we come across in tech where our brains are forced to think twice about what we are doing. Whoever named it this way should be sacked. A simple SET ROWRESULTS ON|OFF would be far simpler to comprehend. &lt;/rant&gt;</p>   <p>Anyway, I spend time trying to debug what is happening. I am able to manually set NOCOUNT on and off inside of T-SQL and see a count of rows affected returned (or not). I check and recheck everything I can think of and feel as if I have lost my mind. I'm starting to question how I ever became certified in SQL Server.</p>   <p>I mean, it's a simple configuration change. This isn't rocket surgery. </p>   <p>So I do what anyone else in this situation would do. </p>   <p>I turn off my laptop and forget about everything for a few days. </p>   <h2 id="h-the-river">The River</h2>   <p>Eventually I decide to reopen my laptop and try again. I am able to reproduce everything. So I ask some friends if they are also seeing similar issues. One friend, Karen LÃ³pez (<a href="https://twitter.com/datachick" target="_blank" rel="noreferrer noopener">@datachick</a>), asked me a few follow up questions. These questions get my mind thinking about other ways to test behavior and debug. I suddenly recall I can check for the options set for my current connection:</p>   <pre class="wp-block-preformatted">DECLARE @options INT SELECT @options = @@OPTIONS PRINT @options IF ( (1 &amp; @options) = 1 ) PRINT 'DISABLE_DEF_CNST_CHK' IF ( (2 &amp; @options) = 2 ) PRINT 'IMPLICIT_TRANSACTIONS' IF ( (4 &amp; @options) = 4 ) PRINT 'CURSOR_CLOSE_ON_COMMIT' IF ( (8 &amp; @options) = 8 ) PRINT 'ANSI_WARNINGS' IF ( (16 &amp; @options) = 16 ) PRINT 'ANSI_PADDING' IF ( (32 &amp; @options) = 32 ) PRINT 'ANSI_NULLS' IF ( (64 &amp; @options) = 64 ) PRINT 'ARITHABORT' IF ( (128 &amp; @options) = 128 ) PRINT 'ARITHIGNORE' IF ( (256 &amp; @options) = 256 ) PRINT 'QUOTED_IDENTIFIER' IF ( (512 &amp; @options) = 512 ) PRINT 'NOCOUNT' IF ( (1024 &amp; @options) = 1024 ) PRINT 'ANSI_NULL_DFLT_ON' IF ( (2048 &amp; @options) = 2048 ) PRINT 'ANSI_NULL_DFLT_OFF' IF ( (4096 &amp; @options) = 4096 ) PRINT 'CONCAT_NULL_YIELDS_NULL' IF ( (8192 &amp; @options) = 8192 ) PRINT 'NUMERIC_ROUNDABORT' IF ( (16384 &amp; @options) = 16384 ) PRINT 'XACT_ABORT'</pre>   <p>Running the above code returns the following result for my connection:</p>   <div class="wp-block-image"><figure class="aligncenter size-large"><img src="https://thomaslarock.com/wp-content/uploads/2021/03/image-4-600x284.png" alt="" class="wp-image-20852"/></figure></div>   <p>And then it hits me. My connection does not have NOCOUNT enabled! I mean, I'm not really surprised, but it is helpful to see that it is missing. I then decide to open a connection with SQLCMD and observe the default behavior for the connection. Sure enough, NOCOUNT is enabled, as expected:</p>   <div class="wp-block-image"><figure class="aligncenter size-large"><img src="https://thomaslarock.com/wp-content/uploads/2021/03/image-5-600x368.png" alt="" class="wp-image-20853"/></figure></div>   <p>My connection string has no additional options, and the NOCOUNT is respected. This is the expected behavior for the instance.</p>   <p>Now I need to verify what is happening under the hood when you connect to SQL Server using SSMS or ADS. Using the default xEvents session I capture the connection string sent when connecting from ADS and find this gem:</p>   <div class="wp-block-image"><figure class="aligncenter size-large"><img src="https://thomaslarock.com/wp-content/uploads/2021/03/image-6-600x181.png" alt="" class="wp-image-20854"/></figure></div>   <p>The NOCOUNT user option configuration item is not recognized when you connect using those tools. Other user options appear to be respected, but for some reason NOCOUNT is ignored. This explains why I was see the unexpected behavior. </p>   <p>I will keep my certifications for now.</p>   <h2 id="h-summary">Summary</h2>   <p>I don't know if this is a bug or a feature. But it is certainly a frustrating experience for an end user like myself. But if I SET NOCOUNT for SQL Server I expect it to apply to all users connecting from that point forward. Since other user options appear to be respected, there must be something different about NOCOUNT. </p>   <p>It should not matter how users are connecting. SSMS and ADS should both respect the server settings. I suspect other tools likely use the same code as SSMS and ADS, meaning you should double check the actual connection string used from your application. It could explain unexpected behavior. </p>