---
layout: post
title: Modify SQL Audit for Azure SQL Database
date: '2020-02-11 10:45:06 +0000'
categories:
- Azure
- Data Security and Privacy
- MSSQL
- SQL MVP
tags:
- Azure
- data security
- sql audit
- SQL Database
- SQL MVP
---

<p>At SQL Server Live last November, I demonstrated enabling SQL Audit for Azure SQL Database. During the class discussion I explained you must use Powershell to modify SQL Audit for Azure SQL Database. So, that's my post today, showing you how it is done. </p>   <p>By default, SQL Audit for Azure SQL Database will enable the following:<br /><br />SUCCESSFUL_DATABASE_AUTHENTICATION_GROUP<br />FAILED_DATABASE_AUTHENTICATION_GROUP<br />BATCH_COMPLETED_GROUP</p>   <p>If you want to alter that list, you must use Powershell. There is no GUI available. (If you connect to Azure SQL Database with SQL Server Management Studio v18.4 you will notice there is no option for Audit Specifications. I believe this should be possible at some point, so feel free to go <a aria-label="upvote this suggestion (opens in a new tab)" rel="noreferrer noopener" href="https://feedback.azure.com/forums/908035-sql-server/suggestions/39679681-add-database-audit-specifications-to-ssms-for-azur" target="_blank">upvote this suggestion</a>.)</p>   <h2>Using Set-AzSqlServerAudit</h2>   <p>Let's look at how to enable the DATABASE_PERMISSION_CHANGE_GROUP audit action group. I chose that Action Group for two reasons. First, it's part of the list I recommend for anyone using <a aria-label="SQL Audit along with Security Event Manager (opens in a new tab)" rel="noreferrer noopener" href="https://thwack.solarwinds.com/community/solarwinds-community/product-blog/blog/2019/12/12/sem-and-sql-server-audit-better-together" target="_blank">SQL Audit along with Security Event Manager</a>. Second, because I was curious to track activity for granting UNMASK when using Dynamic Data Masking. </p>   <p>Here's some sample code that I used to add the DATABASE_PERMISSION_CHANGE_GROUP audit action group:</p>   <pre class="wp-block-code"><code lang="powershell" class="language-powershell">Set-AzSqlServerAudit -ResourceGroupName RGname -ServerName Server -AuditActionGroup SUCCESSFUL_DATABASE_AUTHENTICATION_GROUP, FAILED_DATABASE_AUTHENTICATION_GROUP, BATCH_COMPLETED_GROUP, DATABASE_PERMISSION_CHANGE_GROUP </code></pre>   <p>You can then use Get-AzSqlServerAudit to verify the change:</p>   <figure class="wp-block-image size-large"><img src="https://i0.wp.com/thomaslarock.com/wp-content/uploads/2020/02/image.png?fit=600%2C68&amp;ssl=1" alt="" class="wp-image-19742"/></figure>   <h2>Viewing Audit Logs with Log Analytics</h2>   <p>To test the activity is captured, I grant and revoke UNMASK to a user. I'm pushing the audit logs to Log Analytics, which returns the rows as expected:</p>   <figure class="wp-block-image size-large"><img src="https://i0.wp.com/thomaslarock.com/wp-content/uploads/2020/02/image-1.png?fit=600%2C133&amp;ssl=1" alt="" class="wp-image-19743"/></figure>   <p>From there we can build rules and alerts as needed.</p>   <h2>Summary</h2>   <p>I have been an <a aria-label="advocate of SQL Audit for years (opens in a new tab)" rel="noreferrer noopener" href="https://thomaslarock.com/2014/03/top-5-sql-server-features-arent-using-and-why/" target="_blank">advocate of SQL Audit for years</a>. I was happy to see it added to Azure a while back. However, to modify SQL Audit for Azure SQL Database you must use Powershell. I'm hopeful Microsoft will get this functionality into SSMS at some point in the near future.</p>   <p>Together with Karen LÃ³pez, we will be delivering a full training day at <a rel="noreferrer noopener" href="https://sqlkonferenz.de/" target="_blank">SQL Konferenz</a> in March. The title of our session is <strong>Advanced Data Protection: Security and Privacy Assessments in SQL Server</strong>. The above is a sample of the updated content Karen and I will be sharing. If you are in or around Darmstadt on the 3rd of March, we'd love to see you in our class.</p>   <h2><strong>REFERENCES</strong>: </h2>   <p><a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/auditing/sql-server-audit-action-groups-and-actions?view=sql-server-ver15">https://docs.microsoft.com/en-us/sql/relational-databases/security/auditing/sql-server-audit-action-groups-and-actions?view=sql-server-ver15</a><br /><a href="https://docs.microsoft.com/en-us/powershell/module/az.sql/set-azsqlserveraudit?view=azps-3.4.0">https://docs.microsoft.com/en-us/powershell/module/az.sql/set-azsqlserveraudit?view=azps-3.4.0</a><br /><a href="https://docs.microsoft.com/en-us/sql/relational-databases/security/dynamic-data-masking?view=sql-server-ver15">https://docs.microsoft.com/en-us/sql/relational-databases/security/dynamic-data-masking?view=sql-server-ver15</a></p>